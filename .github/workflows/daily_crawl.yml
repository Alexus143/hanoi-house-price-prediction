name: Auto Crawler & Train Model

# 1. Định nghĩa khi nào chạy
on:
  schedule:
    # Chạy vào 23:00 UTC hàng ngày (tức là 6:00 sáng Việt Nam hôm sau)
    - cron: '0 23 * * *'
  # Cho phép bấm nút chạy tay để test (tab Actions trên Github)
  workflow_dispatch:

# 2. Định nghĩa quyền hạn (quan trọng để được phép ghi đè file data mới)
permissions:
  contents: write

# 3. Các bước thực hiện
jobs:
  build:
    runs-on: ubuntu-latest # Mượn máy Ubuntu mới nhất

    steps:
      - name: 1. Lấy code về máy ảo
        uses: actions/checkout@v4

      - name: 2. Cài đặt Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10' 

      - name: 3. Cài đặt thư viện
        run: |
          pip install -r requirements.txt

      - name: 4. Chạy Crawler (Cào dữ liệu)
        run: python src/crawler.py

      - name: 5. Chạy Cleaner (Làm sạch & Gộp DB)
        run: python src/cleaner.py

      - name: 6. Train lại Model (Học dữ liệu mới)
        run: python src/train_model.py

      - name: 7. Lưu dữ liệu mới vào Git (Commit & Push)
        run: |
          git config --global user.name 'GitHub Action Bot'
          git config --global user.email 'action@github.com'
          git add data/*.csv data/*.db data/*.pkl
          # Kiểm tra xem có gì thay đổi không rồi mới commit
          git diff --quiet && git diff --staged --quiet || (git commit -m "Auto-update data & model" && git push)