name: Auto Crawler & Train Model

# 1. Định nghĩa khi nào chạy
on:
  schedule:
    # Chạy vào 23:00 UTC hàng ngày (tức là 6:00 sáng Việt Nam hôm sau)
    - cron: '0 23 * * *'
  # Cho phép bấm nút chạy tay để test (tab Actions trên Github)
  workflow_dispatch:

# 2. Định nghĩa quyền hạn (quan trọng để được phép ghi đè file data mới)
permissions:
  contents: write

# 3. Các bước thực hiện
jobs:
  build:
    runs-on: ubuntu-latest # Mượn máy Ubuntu mới nhất

    steps:
      - name: 1. Lấy code về máy ảo
        uses: actions/checkout@v4

      - name: 2. Cài đặt Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10' 

      - name: 3. Cài đặt thư viện
        run: |
          pip install -r requirements.txt

      # [QUAN TRỌNG] Chạy module Crawler bằng cờ -m
      - name: 4. Chạy Crawler (Data Loader)
        run: python -m src.data_loader.spider

      # [QUAN TRỌNG] Chạy module Cleaner
      - name: 5. Chạy Cleaner (Preprocessing)
        run: python -m src.preprocessing.cleaner

      # [QUAN TRỌNG] Chạy module Train Model
      - name: 6. Train lại Model (AI Engine)
        run: python -m src.ai_engine.train_model

      - name: 7. Upload Debug Screenshot
        uses: actions/upload-artifact@v4
        if: always() # Luôn chạy dù step trước có lỗi hay không
        with:
          name: debug-screenshot
          path: data/debug_github_actions.png

      - name: 8. Lưu dữ liệu mới vào Git (Commit & Push)
        run: |
          git config --global user.name 'GitHub Action Bot'
          git config --global user.email 'action@github.com'
          # Thêm cả file json (nếu có) và pkl model mới
          git add data/*.csv data/*.db data/*.pkl data/*.json
          # Kiểm tra xem có gì thay đổi không rồi mới commit
          git diff --quiet && git diff --staged --quiet || (git commit -m "Auto-update data & model [CI/CD]" && git push)